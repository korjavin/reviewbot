services:

  # ──────────────────────────────────────────────
  # ReviewBot — GitHub App / Webhook handler
  # ──────────────────────────────────────────────
  reviewbot:
    image: ghcr.io/korjavin/reviewbot:latest
    container_name: reviewbot
    networks:
      - traefik_network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.reviewbot.rule=Host(`${HOSTNAME}`)"
      - "traefik.http.routers.reviewbot.entrypoints=websecure"
      - "traefik.http.routers.reviewbot.tls.certresolver=myresolver"
      - "traefik.http.services.reviewbot.loadbalancer.server.port=8080"
    restart: unless-stopped
    environment:
      - GITHUB_APP_ID=${GITHUB_APP_ID}
      - GITHUB_PRIVATE_KEY=${GITHUB_PRIVATE_KEY}
      - GITHUB_WEBHOOK_SECRET=${GITHUB_WEBHOOK_SECRET}
      - GITHUB_CLIENT_ID=${GITHUB_CLIENT_ID}
      - GITHUB_CLIENT_SECRET=${GITHUB_CLIENT_SECRET}
      - PORT=${PORT:-8080}
      - BASE_URL=${BASE_URL}
      - N8N_WEBHOOK_URL=${N8N_WEBHOOK_URL}

  # ──────────────────────────────────────────────
  # n8n — Pipeline Executor
  # ──────────────────────────────────────────────
  n8n:
    image: docker.n8n.io/n8nio/n8n:latest
    container_name: n8n
    restart: unless-stopped
    networks:
      - traefik_network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.n8n.rule=Host(`${N8N_HOSTNAME}`)"
      - "traefik.http.routers.n8n.entrypoints=websecure"
      - "traefik.http.routers.n8n.tls.certresolver=myresolver"
      - "traefik.http.services.n8n.loadbalancer.server.port=5678"
    environment:
      - N8N_HOST=${N8N_HOSTNAME}
      - N8N_PORT=5678
      - N8N_PROTOCOL=https
      - WEBHOOK_URL=https://${N8N_HOSTNAME}/
      - N8N_BASIC_AUTH_ACTIVE=true
      - N8N_BASIC_AUTH_USER=${N8N_BASIC_AUTH_USER:-admin}
      - N8N_BASIC_AUTH_PASSWORD=${N8N_BASIC_AUTH_PASSWORD}
      # Knowledge Base (AnythingLLM) connection
      - ANYTHINGLLM_URL=http://anythingllm:3001
      - ANYTHINGLLM_API_KEY=${ANYTHINGLLM_API_KEY}
      # LLM provider
      - LLM_PROVIDER=${LLM_PROVIDER:-gemini}
      - LLM_MODEL=${LLM_MODEL}
      - LLM_API_KEY=${LLM_API_KEY}
      # GitHub App (for pipeline nodes)
      - GITHUB_APP_ID=${GITHUB_APP_ID}
      - GITHUB_PRIVATE_KEY=${GITHUB_PRIVATE_KEY}
    volumes:
      - n8n-data:/home/node/.n8n
      # Custom n8n nodes (TypeScript, built as npm package)
      # - ./services/n8n-nodes:/home/node/.n8n/nodes
    depends_on:
      - anythingllm

  # ──────────────────────────────────────────────
  # AnythingLLM — Knowledge Base (POC)
  # ──────────────────────────────────────────────
  anythingllm:
    image: mintplexlabs/anythingllm:latest
    container_name: anythingllm
    restart: unless-stopped
    networks:
      - traefik_network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.anythingllm.rule=Host(`${ANYTHINGLLM_HOSTNAME}`)"
      - "traefik.http.routers.anythingllm.entrypoints=websecure"
      - "traefik.http.routers.anythingllm.tls.certresolver=myresolver"
      - "traefik.http.services.anythingllm.loadbalancer.server.port=3001"
    environment:
      - STORAGE_DIR=/app/server/storage
      - UID=1000
      - GID=1000
      # LLM backend - configure in AnythingLLM UI or via env
      # e.g. use OpenAI-compatible endpoint or Ollama
      # - LLM_PROVIDER=openai
      # - OPEN_AI_KEY=${LLM_API_KEY}
    volumes:
      - anythingllm-data:/app/server/storage
      # Intel markdown files from host — visible in AnythingLLM as "hot dir"
      # Upload to workspace via API: POST /api/v1/document/upload
      - ${INTELS_DIR:-./intels}:/app/server/storage/hotdir:ro

  # ──────────────────────────────────────────────
  # KB Maintainer — keeps ./intels in sync with
  # the AnythingLLM workspace via REST API
  # ──────────────────────────────────────────────
  kb-maintainer:
    image: ghcr.io/korjavin/reviewbot-kb-maintainer:latest
    container_name: kb-maintainer
    restart: unless-stopped
    networks:
      - traefik_network
    environment:
      - ANYTHINGLLM_URL=http://anythingllm:3001
      - ANYTHINGLLM_API_KEY=${ANYTHINGLLM_API_KEY}
      - ANYTHINGLLM_WORKSPACE=${ANYTHINGLLM_WORKSPACE:-intels}
      - INTELS_DIR=/intels
      - STATE_PATH=/state/kb-maintainer.json
      - SYNC_INTERVAL=${KB_SYNC_INTERVAL:-5m}
    volumes:
      - ${INTELS_DIR:-./intels}:/intels:ro
      - kb-maintainer-state:/state
    depends_on:
      - anythingllm

  # ──────────────────────────────────────────────
  # Claude Runner — AI code review engine
  # Accepts POST /review from n8n, clones the repo,
  # runs `claude` with AnythingLLM as an MCP knowledge base,
  # and returns the review text.
  # ──────────────────────────────────────────────
  claude-runner:
    image: ghcr.io/korjavin/reviewbot-claude-runner:latest
    container_name: claude-runner
    restart: unless-stopped
    networks:
      - traefik_network
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - ANYTHINGLLM_URL=http://anythingllm:3001
      - ANYTHINGLLM_API_KEY=${ANYTHINGLLM_API_KEY}
    volumes:
      # Persist the entire /root home so that both ~/.claude.json (auth tokens +
      # user-scope MCP config) and ~/.claude/ (session data) survive restarts.
      # Log in once with: docker exec -it claude-runner claude auth
      - claude-home:/root
    depends_on:
      - anythingllm

volumes:
  n8n-data:
  anythingllm-data:
  kb-maintainer-state:
  claude-home:

networks:
  traefik_network:
    name: ${NETWORK_NAME:-traefik_network}
    external: true
